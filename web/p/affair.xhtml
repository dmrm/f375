<ui:composition template="/WEB-INF/templates/laftemplate.xhtml" 
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:t="http://myfaces.apache.org/tomahawk">
    
    <f:metadata>
        <f:viewParam name="id" value="#{affairMB.id}"/>
        <f:viewParam name="evi" value="#{affairMB.eviId}"/>
        <f:viewParam name="user" value="#{affairMB.userId}"/>
        <f:event type="preRenderView" listener="#{affairMB.init()}" />
    </f:metadata>
        
 
    <ui:define name="tempTitle">Affairs</ui:define>   

    <ui:define name="tempBody">    
        <script>
            document.getElementById("affair").className += 'active';
            function edit(){
                document.getElementById('edit').style.display = 'none'; 
                document.getElementById('editor').style.display = 'block'; 
                var desc = document.getElementById('desc');
                var editarea = document.getElementById('editarea');                
                desc.style.display = 'none';    
                editarea.innerHTML = desc.innerHTML;
            }
            function save(){
                document.getElementById('edit').style.display = 'block'; 
                document.getElementById('editor').style.display = 'none';
            }
        </script>
        <style>
            .row-fluid [class="span1"]:nth-child(12n+1) {
                margin-left: 0;                                             
            }
            .row-fluid [class="span2"]:nth-child(12n+1) {
                margin-left: 0;                                             
            }
        </style>
        <h:panelGroup layout="block" id="userMessage" class="alert alert-success" rendered="#{not empty affairMB.userId and not empty affairMB.user}">
                <button class="close" data-dismiss="alert" type="button" onclick="document.getElementById('userMessage').style.display = 'none'">
                   ×
                </button>
                Affair was successfully shared with #{affairMB.user.name}
            </h:panelGroup>
            <h:panelGroup layout="block" id="eviMessage" class="alert alert-success" rendered="#{not empty affairMB.eviId and affairMB.evi.affair.id == affairMB.id}">
                <button class="close" data-dismiss="alert" type="button" onclick="document.getElementById('eviMessage').style.display = 'none'">
                   ×
                </button>
                Evidence <h:outputLink value="/Oatmeal#{affairMB.evi.eviPath}">##{affairMB.eviId}</h:outputLink> was successfully added
            </h:panelGroup>
            <h:panelGroup layout="block" id="errMessage" class="alert alert-error" rendered="#{facesContext.validationFailed}">
                <button class="close" data-dismiss="alert" type="button" onclick="document.getElementById('errMessage').style.display = 'none'">
                   ×
                </button>
                <h:messages style="margin: 0px 15px"/>
            </h:panelGroup>
            <div class="container-fluid" style="margin: 40px 0px;">
                <div class="row-fluid">
                    <div class="span6 offset1">
                        <div class="row-fluid">
                            <div class="span4">
                                <h:graphicImage class="decor_block" name="imgs/folder.png"/>
                            </div>
                            <div class="span8">
                                <h3 style="font-weight: 100;">Affair ##{affairMB.affair.id}</h3>
                                <i><h:outputLabel value="It's your affair." rendered="#{usersMB.currentUser() == affairMB.affair.owner.login}"/></i>
                                <i><h:outputLabel value="It's affair of #{affairMB.affair.owner.name}." rendered="#{usersMB.currentUser() != affairMB.affair.owner.login}"/></i>
                                <h:form prependId="false">
                                    <h:outputText id="desc"  value="#{affairMB.updateDescription()}"/>
                                    <a id="edit" onclick="edit();">
                                        edit..
                                    </a>
                                    <div id="editor"  style="display: none">
                                    <h:inputTextarea id="editarea" value="#{affairMB.description}" style="width: 100%"/>
                                    <h:commandLink id="save" onclick="save();" value="save..">
                                        <f:ajax execute="editarea" render="desc"/>
                                    </h:commandLink>                                        
                                    </div>
                                </h:form>                                
                            </div>
                        </div>
                        <br/>
                        <div class="row-fluid decor_block">
                            <div class ="row-fluid">
                                <div class="span10">
                                    <h3 style="margin: 0px 10px; font-weight: 100">Evidences</h3>
                                </div>
                                <div class="span2">
                                    <button class="btn btn-primary pull-right" onclick="document.getElementById('eviContainer').style.display = 'block'">Add</button>
                                </div>                                
                            </div>
                            <legend></legend>
                            <div class="container-fluid">
                                <div class="row-fluid">
                                    <!--<a style="display: none"/>-->
                                    <ui:repeat value="#{affairMB.evidences}" var="evi">                                    
                                            <h:outputLink class="span1" value="/Oatmeal#{evi.eviPath}" style="text-decoration: none"><abbr title="#{evi.description}">#{evi.id}</abbr></h:outputLink>                                    
                                    </ui:repeat>
                                </div>
                            </div>
                        </div>
                        <br/>
                        <div class="row-fluid decor_block">
                            <div class ="row-fluid">
                                <div class="span9">
                                    <h3 style="margin: 0px 10px; font-weight: 100">Users</h3>
                                </div>
                                <div class="span3">
                                    <button onclick="getElementById('usrContainer').style.display = 'block';" class="btn btn-primary pull-right">Add</button>
                                </div>                                
                            </div>
                            <legend></legend>                            
                            <div class="container-fluid">
                                <div class="row-fluid">
                                    <ui:repeat value="#{affairMB.users}" var="user">
                                        <div class="span2" style="text-align: center">
                                            <h:graphicImage value="#{user.photo}" class="img-rounded"/>
                                            #{user.name}<br/>
                                        </div>
                                    </ui:repeat>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="span3 offset1">
                        <div class="decor_block">
                            <h:form>
                                <br/>
                                <div class="row-fluid">
                                    <h:inputTextarea class="span10 offset1" value="#{messageMB.text}" label="Message">
                                        <f:validateLength minimum="1" maximum="1000"/>
                                    </h:inputTextarea>
                                </div>
                                <div class="row-fluid">
                                    <h:commandButton class="btn span3 offset8" action="#{messageMB.newMessage(affairMB.id)}" value="Send"/>
                                </div>
                            </h:form>
                        </div>
                        <br/>
                        <div class="decor_block">
                            <h3 style="margin: 0px 10px; font-weight: 100">Messages</h3>
                            <legend></legend>
                            <ui:repeat value="#{messageMB.getMessages(affairMB.id)}" var="message">
                                <h:panelGroup layout="block" rendered="#{request.remoteUser == message.user.login}">
                                    <blockquote class="squared_block" style="background: #eaffff">
                                        <p>#{message.text}</p>
                                        <small>#{message.user.name}:<h:outputText value="#{message.dateM}" >
                                                                                <f:convertDateTime pattern=" dd.MM.yyyy HH:mm" />
                                                                   </h:outputText>
                                        </small>
                                    </blockquote>
                                </h:panelGroup>
                                <h:panelGroup layout="block" rendered="#{request.remoteUser != message.user.login}">
                                    <blockquote class="squared_block" style="background: #ffffde">
                                        <p>#{message.text}</p>
                                        <small>#{message.user.name}:<h:outputText value="#{message.dateM}" >
                                                                                <f:convertDateTime pattern=" dd.MM.yyyy HH:mm" />
                                                                   </h:outputText>
                                        </small>
                                    </blockquote>
                                </h:panelGroup>
                            </ui:repeat>
                        </div>
                    </div>
                </div>
            </div> 
        <div layout="block" id="eviContainer" class="popup-container">
             <!--onclick="document.getElementById('popup-container').style.display = 'none'"-->            
            <div class="container-fluid" id="choose-evi">                
                <div class="row-fluid">
                    <div id="eviBlock" class="span6 offset3 popup-block decor_block">                        
                        <h3 style="margin: 0px 10px; font-weight: 100">Load evidence</h3>
                        <legend></legend>                        
                            <h:form id="eviForm" class="form-horizontal" enctype="multipart/form-data">   
                                <div class="container">
                                    <div class="row">
                                        <div class="control-group">
                                            <div class="controls">
                                                <t:inputFileUpload id="file" value="#{evidenceMB.file}" style="display: none" label="File">
                                                    <f:validateLength minimum="1"/>
                                                    <f:validator validatorId="fileValidator"/>
                                                </t:inputFileUpload>                        
                                                <div id="photo" class="input-append">
                                                   <input id="photoCover" readonly="readonly" type="text"/>
                                                   <a class="btn" onclick="$('input[id=eviForm\\:file]').click();">Browse</a>
                                                </div>
                                                <span class="help-block" style="color: lightgray; margin: 0px;font-size: smaller">max 10MB</span>
                                                <script type="text/javascript">
                                                    $('input[id=eviForm\\:file]').change(function() {
                                                       $('#photoCover').val($(this).val());
                                                    });
                                                </script>                                     
                                            </div>                                            
                                        </div>
                                        <div class="control-group">
                                            <div class="controls">
                                                <h:inputTextarea value="#{evidenceMB.description}" label="description">
                                                    <f:validateLength maximum="1000"/>
                                                </h:inputTextarea>
                                            </div>
                                        </div> 
                                        <div class="control-group">
                                            <div class="controls">
                                                <div class="btn-group">
                                                    <h:commandButton class="btn btn-primary" action="#{evidenceMB.loadEvi(affairMB.id)}" value="Add"/>
                                                    <h:commandButton class="btn" type="reset" onclick="document.getElementById('eviContainer').style.display = 'none'" value="Cancel"/>
                                                </div>
                                            </div>
                                        </div>                                        
                                    </div>
                                </div>
                            </h:form>
                    </div>
                </div>
            </div>
        </div>   
        <div id="usrContainer" class="popup-container">
            <div class="container-fluid" id="choose-evi">                
                <div class="row-fluid">
                    <div id="usrBlock" class="span6 offset3 popup-block decor_block">                        
                        <h3 style="margin: 0px 10px; font-weight: 100">Select users</h3>
                        <legend></legend>
                        <h:form>
                            <div class="row">
                                <div class="span10 offset1">
                                    <ui:repeat value="#{affairMB.responsibleUsers}" var="user">
                                        <h:commandLink action="#{affairMB.attachUser(user.login)}">
                                            <div class="span2" style="text-align: center">
                                                <h:graphicImage value="#{user.photo}"/>
                                                #{user.name}
                                            </div>
                                        </h:commandLink>
                                    </ui:repeat>
                                </div>
                            </div>
                            <h:commandButton class="btn span2 offset1" type="reset" style="margin-left: 20px" onclick="getElementById('usrContainer').style.display = 'none';" value="Cancel"/>
                        </h:form>
                    </div>
                </div>
            </div>
        </div>
    </ui:define>
</ui:composition>
